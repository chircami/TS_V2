<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Contratos PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Estilo para un mejor aspecto en los campos de formulario */
        body {
            background-color: #000000;
            font-family: 'Inter', sans-serif;
        }
        .form-input, .form-select {
            transition: border-color 0.3s ease;
            border: 1px solid #111827; /* Borde negro fino y minimalista */
            /* --- AQUÍ PUEDES CAMBIAR LA ALTURA Y EL ESPACIADO INTERIOR --- */
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 0.75rem; /* Espaciado interior izquierdo */
            padding-right: 0.75rem; /* Espaciado interior derecho */
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #16a34a; /* Green to match the generate button */
            box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2);
        }
        /* Estilo para el desplegable de idioma con flecha a la izquierda */
        .form-select-left-arrow {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem; /* Espacio para el icono */
        }
        .btn-primary {
            background-color: white;
            color: #111827;
            border: 2px solid #111827;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #16a34a; /* Green */
            color: white;
            border-color: #16a34a;
        }
        /* Nuevos estilos para los botones de añadir y quitar */
        .btn-icon-add, .btn-icon-remove {
            background-color: white;
            border: 1px solid #111827;
            transition: all 0.3s ease;
        }
        .btn-icon-add svg, .btn-icon-remove svg {
            fill: #111827; /* Icono negro por defecto */
            transition: fill 0.3s ease;
        }
        .btn-icon-remove:hover {
            background-color: #ef4444; /* Rojo */
            border-color: #ef4444;
        }
        .btn-icon-remove:hover svg {
            fill: white;
        }
        .btn-icon-add:hover {
            background-color: #22c55e; /* Verde */
            border-color: #22c55e;
        }
        .btn-icon-add:hover svg {
            fill: white;
        }
         /* Estilos para la validación */
        input:invalid, select:invalid {
            border-color: #ef4444; /* Rojo para campos inválidos */
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="bg-black min-h-screen flex flex-col items-center justify-center p-4">
        <img id="logo-white" src="https://raw.githubusercontent.com/chircami/TS_V2/master/AP-alargado-white.png" alt="Logo Blanco" class="mx-auto mb-20 w-[440px]" />
        <div class="w-full max-w-[220px] text-center">
            <div class="mb-4">
                <input type="password" id="access-code" class="bg-black text-white border border-white w-full rounded-full text-center text-lg tracking-widest py-3 px-4 focus:outline-none focus:ring-2 focus:ring-white" placeholder="Password">
                <p id="login-error" class="text-red-500 text-sm mt-2 hidden">Código incorrecto.</p>
            </div>
            
            <button id="login-button" class="w-full bg-black text-white border border-white font-bold py-3 px-4 rounded-full hover:bg-white hover:text-black transition mt-4">Entrar</button>
        </div>
    </div>

    <!-- Contenido Principal (Oculto por defecto) -->
    <div id="main-content" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-4xl">
            <div class="bg-white rounded-2xl shadow-lg p-6 md:p-10">
                <header class="text-center mb-14">
                    <!-- Logo centrado en la cabecera -->
                    <img id="logo" src="https://raw.githubusercontent.com/chircami/TS_V2/master/AP-alargado-black.png" alt="Logo" class="mx-auto mb-12 w-40" />
                    <h1 class="text-3xl font-bold text-gray-600">Genera un contrato TS/LP multidioma.</h1>
                </header>

                <!-- Formulario de Contrato -->
                <form id="contract-form" class="space-y-6 pt-2" novalidate>
                    <!-- Selector de Idioma -->
                    <div class="w-full md:w-1/2">
                        <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Idioma del Contrato</label>
                        <select id="language" class="form-select form-select-left-arrow w-full rounded-full" required>
                            <option value="it"selected>Italiano</option>
                            <option value="fr">Francés</option>
                            <option value="es">Español</option>
                            <option value="en">Inglés</option>
                        </select>
                    </div>

                    <!-- Sección de Cliente y Fechas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="client-code" class="block text-sm font-medium text-gray-700 mb-1">Código de Cliente</label>
                            <input type="text" id="client-code" class="form-input w-full rounded-full" placeholder="CLI-001" required>
                            <div id="client-code-error" class="text-red-500 text-sm mt-1 hidden">El código de cliente no existe en la base de datos.</div>
                        </div>
                        <div>
                            <label for="contact-name" class="block text-sm font-medium text-gray-700 mb-1">Contacto</label>
                            <input type="text" id="contact-name" class="form-input w-full rounded-full" placeholder="Ej: Maria López" required>
                        </div>
                        <div>
                            <label for="send-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Envío / Recogida</label>
                            <input type="date" id="send-date" class="form-input w-full rounded-full" required>
                        </div>
                        <div>
                            <label for="return-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Devolución</label>
                            <input type="date" id="return-date" class="form-input w-full rounded-full" required>
                        </div>
                    </div>

                    <!-- Sección de Artículos (Vestidos) -->
                    <div class="border-t border-gray-200 pt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Artículos del Contrato</h2>
                        </div>
                        <div id="items-container" class="space-y-4">
                            <!-- Los artículos se añadirán aquí dinámicamente -->
                        </div>
                    </div>

                    <!-- Sección de Coste Total -->
                    <div class="border-t border-gray-200 pt-6 text-right">
                         <div class="flex justify-end items-center">
                            <span class="text-lg font-semibold text-gray-700 mr-4">Coste Total:</span>
                            <input type="text" id="total-cost" class="form-input w-40 rounded-full text-right font-bold text-xl" readonly value="0.00 €">
                         </div>
                    </div>
                    
                    <!-- Botón de Generar PDF -->
                    <div class="text-center pt-4">
                        <button type="button" id="generate-pdf-btn" class="btn-primary font-bold py-3 px-8 rounded-full text-lg shadow-lg">
                            Generar Contrato PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const { jsPDF } = window.jspdf;

            // --- LÓGICA DE LOGIN ---
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const loginButton = document.getElementById('login-button');
            const accessCodeInput = document.getElementById('access-code');
            const loginError = document.getElementById('login-error');
            const correctAccessCode = '2025'; // Código de acceso

            loginButton.addEventListener('click', () => {
                if (accessCodeInput.value === correctAccessCode) {
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    document.body.style.backgroundColor = '#f3f4f6'; // Cambiar fondo para el formulario
                } else {
                    loginError.classList.remove('hidden');
                }
            });
            
            accessCodeInput.addEventListener('input', () => {
                 loginError.classList.add('hidden');
            });


            // --- LÓGICA DEL GENERADOR DE CONTRATOS ---

            // Base de datos de clientes (para prueba)
            const customerDatabase = {
                "CLI-001": {
                    nombreFiscal: "Empresa Ficticia S.L.",
                    nombreComercial: "Tienda de Vestidos Ejemplo",
                    vat: "B12345678",
                    direccion: "Calle Falsa 123, 08001 Barcelona, España"
                },
                "CLI-002": {
                    nombreFiscal: "Moda Creativa S.A.",
                    nombreComercial: "Boutique La Rosa",
                    vat: "A87654321",
                    direccion: "Avenida Diagonal 456, 08002 Barcelona, España"
                }
            };

            // Traducciones
            const translations = {
                es: {
                    title: "CONTRATO DE ALQUILER",
                    clientCode: "Código de Cliente:",
                    clientName: "Contacto:",
                    customerDataText: "El presente contrato se celebra con la entidad {fiscalName} (nombre comercial: {commercialName}), con número de identificación fiscal {vat} y domicilio en {address}, representado por {contactName} por un importe de {Total}.",
                    sendDate: "Fecha de Envío/Recogida:",
                    returnDate: "Fecha de Devolución:",
                    dressName: "Nombre del Vestido",
                    unitCost: "Coste Unitario",
                    totalCost: "Coste Total:",
                    termsTitle: "Términos y Condiciones"
                },
                en: {
                    title: "RENTAL AGREEMENT",
                    clientCode: "Client Code:",
                    clientName: "Contact:",
                    customerDataText: "This agreement is made with the entity {fiscalName} (commercial name: {commercialName}), with tax identification number {vat} and address at {address}, represented by {contactName} for a total amount of {Total}.",
                    sendDate: "Dispatch/Pickup Date:",
                    returnDate: "Return Date:",
                    dressName: "Dress Name",
                    unitCost: "Unit Cost",
                    totalCost: "Total Cost:",
                    termsTitle: "Terms and Conditions"
                },
                it: {
                    title: "CONTRATTO Trunk Show 2025",
                    clientCode: "Codice Cliente:",
                    clientName: "Contatto:",
                    customerDataText: "*DATI DELLE PARTI*\nDa un lato, AP CUBED, S.L.U., con C.I.F. B09864760 e indirizzo in Calle Lagasca nº 99 Esc. B2, 8B2A, 28006 Madrid; di seguito AP CUBED; e, dall'altro lato, {fiscalName} (nome commerciale: {commercialName}), P.I.: {vat} e domicilio in {address}. Rappresentato da {contactName} (codice cliente: {clientCode}).\n\n*CONDIZIONI PARTICOLARI*\nIl cliente accetta le seguenti condizioni per un importo totale di {Total}.",
                    sendDate: "Data di Spedizione/Ritiro:",
                    returnDate: "Data di Restituzione:",
                    dressName: "Nome del Vestido",
                    unitCost: "Costo Unitario",
                    totalCost: "Costo Totale:",
                    termsTitle: "Termini e Condizioni"
                },
                fr: {
                    title: "CONTRAT DE LOCATION",
                    clientCode: "Code Client:",
                    clientName: "Contact:",
                    customerDataText: "Le présent contrat est conclu avec l'entité {fiscalName} (nom commercial: {commercialName}), avec le numéro d'identification fiscale {vat} et domiciliée à {address}, representé par {contactName} pour un montant total de {Total}.",
                    sendDate: "Date d'Envoi/Retrait:",
                    returnDate: "Date de Retour:",
                    dressName: "Nom de la Robe",
                    unitCost: "Coût Unitaire",
                    totalCost: "Coût Total:",
                    termsTitle: "Termes et Conditions"
                }
            };
            
            const form = document.getElementById('contract-form');
            const itemsContainer = document.getElementById('items-container');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const totalCostInput = document.getElementById('total-cost');
            const clientCodeInput = document.getElementById('client-code');
            const clientCodeError = document.getElementById('client-code-error');
            let itemCounter = 0;

            // Ocultar error al escribir en el campo de código de cliente
            clientCodeInput.addEventListener('input', () => {
                clientCodeError.classList.add('hidden');
            });

            // Función para actualizar el coste total
            const updateTotalCost = () => {
                let total = 0;
                const itemCosts = document.querySelectorAll('.item-cost');
                itemCosts.forEach(input => {
                    const value = parseFloat(input.value) || 0;
                    total += value;
                });
                totalCostInput.value = `${total.toFixed(2)} €`;
            };

            // Función para añadir listeners a los nuevos elementos
            const updateEventListeners = () => {
                // Para eliminar un artículo
                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.removeEventListener('click', handleRemoveItem);
                    button.addEventListener('click', handleRemoveItem);
                });

                // Para añadir un nuevo artículo (ahora dinámico)
                document.querySelectorAll('.add-item-btn').forEach(button => {
                    button.removeEventListener('click', addNewItem);
                    button.addEventListener('click', addNewItem);
                });

                // Para actualizar el coste total
                document.querySelectorAll('.item-cost').forEach(input => {
                    input.removeEventListener('input', updateTotalCost);
                    input.addEventListener('input', updateTotalCost);
                });
            };
            
            const handleRemoveItem = (e) => {
                const itemToRemove = e.target.closest('.item-row');
                const wasLastItem = itemToRemove === itemsContainer.lastElementChild;

                if (itemsContainer.children.length > 1) {
                    itemToRemove.remove();
                }

                if (wasLastItem && itemsContainer.children.length > 0) {
                    const newLastItemActions = itemsContainer.lastElementChild.querySelector('.actions-container');
                    if (!newLastItemActions.querySelector('.add-item-btn')) {
                        const addButton = document.createElement('button');
                        addButton.type = 'button';
                        addButton.className = 'btn-icon-add rounded-full p-2 add-item-btn';
                        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>`;
                        newLastItemActions.appendChild(addButton);
                    }
                }
                
                updateTotalCost();
                updateEventListeners();
            };

            // Añadir un nuevo artículo
            const addNewItem = () => {
                // Quitar el botón de añadir del anterior último elemento
                const lastAddButton = itemsContainer.querySelector('.add-item-btn');
                if (lastAddButton) {
                    lastAddButton.remove();
                }

                itemCounter++;
                const newItem = document.createElement('div');
                newItem.classList.add('grid', 'grid-cols-1', 'md:grid-cols-10', 'gap-4', 'items-center', 'item-row');
                newItem.innerHTML = `
                    <div class="md:col-span-5">
                        <label class="text-sm font-medium text-gray-700 sr-only">Nombre del Vestido</label>
                        <input type="text" placeholder="Nombre del Vestido ${itemCounter}" class="form-input w-full rounded-full item-name" required>
                    </div>
                    <div class="md:col-span-3">
                        <label class="text-sm font-medium text-gray-700 sr-only">Coste Unitario</label>
                        <input type="number" placeholder="Coste Unitario (€)" min="0" step="0.01" class="form-input w-full rounded-full item-cost text-right" required>
                    </div>
                    <div class="md:col-span-2 text-center">
                        <div class="flex justify-center items-center space-x-2 actions-container">
                             <button type="button" class="btn-icon-remove rounded-full p-2 remove-item-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button type="button" class="btn-icon-add rounded-full p-2 add-item-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                itemsContainer.appendChild(newItem);
                updateEventListeners();
            };

            // Helper: cargar una imagen remota y devolver dataURL
            const loadImageAsDataURL = (url) => {
                return new Promise((resolve, reject) => {
                    if (!url) return reject(new Error('No image URL'));
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            // Mantenemos el formato PNG para preservar la calidad y transparencia
                            const dataURL = canvas.toDataURL('image/png'); 
                            resolve({ dataURL, width: canvas.width, height: canvas.height });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = url;
                });
            };
            
            // Helper: Imprimir texto con estilos mixtos (normal y negrita) y auto-wrap
            const printMixedStyleText = (doc, textParts, x, y, maxWidth, lineHeight) => {
                let currentX = x;
                let currentY = y;

                textParts.forEach(part => {
                    if (part.style === 'break') {
                        currentY += lineHeight;
                        currentX = x;
                        return;
                    }
                
                    doc.setFont('helvetica', part.style || 'normal');
                    const tokens = part.text.match(/\s+|\S+/g) || [];

                    tokens.forEach(token => {
                        const tokenWidth = doc.getStringUnitWidth(token) * doc.internal.getFontSize() / doc.internal.scaleFactor;

                        if (currentX > x && currentX + tokenWidth > x + maxWidth && token.trim() !== '') {
                            currentY += lineHeight;
                            currentX = x;
                        }
                        
                        if (currentX === x && token.trim() === '') {
                           return; // No imprimir espacios al inicio de una nueva línea
                        }

                        doc.text(token, currentX, currentY);
                        currentX += tokenWidth;
                    });
                });
                return currentY;
            };

            // Generar el PDF (ahora async para poder await la carga del logo)
            generatePdfBtn.addEventListener('click', async () => {
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                const clientCode = document.getElementById('client-code').value;
                 // Validar si el cliente existe en la BD
                if (!customerDatabase[clientCode]) {
                    clientCodeError.classList.remove('hidden');
                    return;
                } else {
                    clientCodeError.classList.add('hidden');
                }

                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.getWidth();

                const selectedLang = document.getElementById('language').value;
                const T = translations[selectedLang];

                // Obtener datos del formulario
                const contactName = document.getElementById('contact-name').value;
                const sendDate = document.getElementById('send-date').value;
                const returnDate = document.getElementById('return-date').value;
                const totalCost = totalCostInput.value;


                 // Buscar datos del cliente en la base de datos UNA SOLA VEZ
                const customerData = customerDatabase[clientCode];

                // Intentar cargar el logo mostrado en la cabecera y añadirlo centrado en el PDF
                const logoEl = document.getElementById('logo');
                let titleY = 20; // valor por defecto si no hay logo
                let dateY;
                try {
                    if (logoEl && logoEl.src) {
                        const logoData = await loadImageAsDataURL(logoEl.src);
                        // Definir ancho en mm (ajusta según necesites)
                        const logoDisplayWidth = 50;
                        const aspect = logoData.height / logoData.width;
                        const logoDisplayHeight = logoDisplayWidth * aspect;
                        const x = pageWidth - logoDisplayWidth - 14; // ALINEAR A LA DERECHA
                        const y = 10; // margen superior
                        doc.addImage(logoData.dataURL, 'PNG', x, y, logoDisplayHeight); // Usar PNG
                        titleY = y + logoDisplayHeight + 25; // MÁS ESPACIO
                    }
                } catch (err) {
                    console.warn('No se pudo cargar el logo para el PDF:', err);
                }

                // Título (centrado)
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(T.title, pageWidth / 2, titleY, { align: 'center' });

                // Fecha de hoy (automática) - DEBAJO del título a la izquierda
                const today = new Date();
                const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                dateY = titleY + 8; // Posición Y debajo del título
                doc.text(formattedDate, 14, dateY, { align: 'left' });

                // Información del Cliente y Fechas (etiqueta normal, valor en negrita)
                const xStart = 14;
                let yPos = dateY + 12; // Inicia después de la fecha
                doc.setFontSize(8);

                const formatInputDate = (dateStr) => {
                    if (!dateStr) return '';
                    const [year, month, day] = dateStr.split('-');
                    return `${day}/${month}/${year}`;
                };

                const printLabelValue = (label, value) => {
                    doc.setFont('helvetica', 'normal');
                    doc.text(label, xStart, yPos);
                    const labelWidth = doc.getStringUnitWidth(label) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(value, xStart + labelWidth, yPos);
                    yPos += 5; // Espacio entre líneas reducido
                };

                let displayClientCode = clientCode;
                if (customerData && customerData.nombreComercial) {
                    displayClientCode = `${clientCode} - ${customerData.nombreComercial}`;
                }
                printLabelValue(T.clientCode + " ", displayClientCode);
                printLabelValue(T.clientName + " ", contactName);
                printLabelValue(T.sendDate + " ", formatInputDate(sendDate));
                printLabelValue(T.returnDate + " ", formatInputDate(returnDate));


                // Tabla de artículos (contenido en negrita)
                const tableColumn = [T.dressName, T.unitCost];
                const tableRows = [];

                document.querySelectorAll('.item-row').forEach(row => {
                    const name = row.querySelector('.item-name').value;
                    const cost = parseFloat(row.querySelector('.item-cost').value || 0).toFixed(2) + " €";
                    tableRows.push([name, cost]);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    foot: [
                        [{ content: T.totalCost, styles: { halign: 'right' } }, { content: totalCost, styles: { halign: 'right' } }]
                    ],
                    startY: yPos + 5, // Usar la nueva posición de Y
                    theme: 'grid',
                    headStyles: { fillColor: [172, 180, 172], fontSize: 8 },
                    styles: { fontStyle: 'bold', fontSize: 8 },
                    footStyles: { fontStyle: 'bold', fontSize: 9, textColor: [0, 0, 0], fillColor: [240, 240, 240] },
                    columnStyles: {
                        1: { cellWidth: 40, halign: 'right' } // Columna de precio más estrecha y alineada a la derecha
                    }
                });

                // Coste Total ahora está en el footer de la tabla
                let finalY = doc.autoTable.previous.finalY;
                const pageHeight = doc.internal.pageSize.getHeight();

                // --- FIX: Check if we need a new page for the footer content ---
                if (finalY > pageHeight - 60) { // 60mm space needed for total + terms
                    doc.addPage();
                    finalY = 20; // Reset Y to top margin on new page
                }

                // Términos y Condiciones
                let termsYPos = finalY + 15; // Posicionado relativo al final de la tabla
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(T.termsTitle, 14, termsYPos);
                
                let lastY = termsYPos + 8;

                // MOVED: Buscar datos del cliente en la base de datos y ponerlos aquí
                if (customerData) {
                    const textParts = [];
                    // Regex para capturar *títulos*, {variables} y \n (saltos de línea)
                    const regex = /(\*.*?\*)|(\{.*?\})|(\n)/g;
                    const splitText = T.customerDataText.split(regex).filter(Boolean);

                    const placeholders = {
                        '{fiscalName}': customerData.nombreFiscal,
                        '{commercialName}': customerData.nombreComercial,
                        '{vat}': customerData.vat,
                        '{address}': customerData.direccion,
                        '{contactName}': contactName,
                        '{clientCode}': clientCode,
                        '{Total}': totalCost
                    };

                    splitText.forEach(segment => {
                        if (segment === '\n') {
                            textParts.push({ text: '\n', style: 'break' });
                        } else if (segment.startsWith('*') && segment.endsWith('*')) {
                            textParts.push({ text: segment.slice(1, -1), style: 'bold' });
                        } else if (placeholders[segment]) {
                            textParts.push({ text: placeholders[segment], style: 'bold' });
                        } else {
                            textParts.push({ text: segment, style: 'normal' });
                        }
                    });
                    
                    doc.setFontSize(8);
                    lastY = printMixedStyleText(doc, textParts, 14, lastY, pageWidth - 28, 4);
                }

                // Guardar el PDF
                doc.save(`contrato_${contactName.replace(/\s+/g, '_') || 'contacto'}.pdf`);
            });

            // Añadir un artículo inicial al cargar la página
            addNewItem();
        });
    </script>
</body>
</html>
